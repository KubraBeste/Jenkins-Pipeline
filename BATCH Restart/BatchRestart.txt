pipeline {
    agent any
    #Ortama g√∂re deƒüi≈ütirilmeli
    environment {
        BATCH_HOST = ""
        DB_HOST = ""
        DB_SERVICE = "SERVICE_NAME/SID"
        SSH_CRED_ID = 'ccb-deploy-ssh'
        DB_CRED_ID  = 'ccb-db-cred'
        TARGET_HOST = ''
        ORACLE_HOME = '...'
    }

    stages {

        stage('Batch Restart ()') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                       keyFileVariable: 'SSH_KEY',
                                                       usernameVariable: 'SSH_USER')]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@\$TARGET_HOST '
                                
                                echo "üîç ThreadPoolWorker process aranƒ±yor..."

                                line=\$(ps -ef | grep java | grep threadpoolworker.DEFAULT | grep -v grep)

                                if [ -z "\$line" ]; then
                                    echo "‚ùå ThreadPoolWorker bulunamadƒ±."
                                    exit 1
                                fi

                                echo "üìÑ Bulunan satƒ±r:"
                                echo "\$line"

                                MYPID=\$(echo "\$line" | awk "{print \\\$2}")
                                MYPPID=\$(echo "\$line" | awk "{print \\\$3}")

                                echo "üîé PID: \$MYPID"
                                echo "üîé PPID: \$MYPPID"

                                echo "üõë Processler √∂ld√ºr√ºl√ºyor..."
                                kill -9 \$MYPID
                                kill -9 \$MYPPID || true

                                echo "‚úÖ Batch process ba≈üarƒ±yla √∂ld√ºr√ºld√º."
                            '
                        """
                    }
                }
            }
        }

        stage('DB Cache Temizleme') {
                    steps {
                        script {
                            withCredentials([
                                sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                  keyFileVariable: 'SSH_KEY',
                                                  usernameVariable: 'SSH_USER'),
                                usernamePassword(credentialsId: DB_CRED_ID,
                                                 usernameVariable: 'DB_USER',
                                                 passwordVariable: 'DB_PASS')
                            ]) {
                
                                sh """
                                        ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${BATCH_HOST} '
                                            echo "üßπ DB Cache temizleme ba≈ülatƒ±lƒ±yor..."
                                            export ORACLE_HOME=/appdata/oracle_client/product/12.2.0/client_1
                                            export PATH=\$ORACLE_HOME/bin:\$PATH
                                        
                                            \$ORACLE_HOME/bin/sqlplus ${DB_USER}/${DB_PASS}@//${DB_HOST}:1521/${DB_SERVICE} <<EOF
                                            @/appdata/scripts/batchcacheremove.sql
                                            exit;
                                        EOF
                                        
                                            echo "‚úÖ DB Cache temizleme tamamlandƒ±."
                                        '
                                        """
                            }
                        }
                    }
                }
              
        stage('Batch Start ()') {
                    steps {
                        script {
                            withCredentials([sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                              keyFileVariable: 'SSH_KEY',
                                                              usernameVariable: 'SSH_USER')]) {
                
                                sh """
                                ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@$BATCH_HOST '
                                    echo "üöÄ Batch yeniden ba≈ülatƒ±lƒ±yor..."
                                    sh /appdata/scripts/splenv.sh << "EOF"
                                    sh /appdata/ouaf/CCBMIG/bin/spl.sh -b start
                                    EOF
                                    echo "‚úÖ Batch ba≈üarƒ±yla ba≈ülatƒ±ldƒ±."
                                '
                                """
                            }
                        }
                    }
                }




    }
}
