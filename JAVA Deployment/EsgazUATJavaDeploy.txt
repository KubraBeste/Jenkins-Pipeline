pipeline {
    agent any

    parameters {
        string(
            name: 'TICKET_PATHS',
            defaultValue: '2025/09/CTM-5228,2025/10/CTM-6001',
            description: 'Birden fazla ticketÄ± virgÃ¼lle ayÄ±rarak yaz (Ã¶rn: 2025/09/CTM-5228,2025/10/CTM-6001)'
        )
    }

    environment {
        GIT_REPO_URL = 'git_url'
        SSH_CRED_ID  = 'ccb-deploy-ssh'
        REMOTE_HOST  = ''
		BATCH_HOST = ''
        BASE_DIR     = ''
    }

    stages {

        stage('Checkout') {
            steps {
                script {
                    echo "ğŸ“¦ Git deposu indiriliyor..."

                    git branch: 'master',
                        credentialsId: 'gitlab-account-token',
                        url: "${GIT_REPO_URL}"

                    // Ticket listesini al
                    tickets = params.TICKET_PATHS.split(',').collect { it.trim() }

                    // Her ticket kontrol edilir
                    tickets.each { t ->
                        sh "ls -l '${t}' || (echo 'âŒ ${t} klasÃ¶rÃ¼ bulunamadÄ±!' && exit 1)"
                    }

                    echo "ğŸŸ Ticket listesi: ${tickets}"
                }
            }
        }

        stage('Paket OluÅŸturma ve Java Kopyalama') {
            steps {
                script {
                    echo "ğŸ“¦ isimdegistirmeoto.sh Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor ve yeni klasÃ¶r belirleniyor..."
                    
                    def newFolder = ''

                    withCredentials([sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                      keyFileVariable: 'SSH_KEY',
                                                      usernameVariable: 'SSH_USER')]) {

                        newFolder = sh(
                            script: """
                                ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no "\$SSH_USER"@${REMOTE_HOST} "bash ${BASE_DIR}/isimdegistirmeoto.sh" | head -n 1
                            """,
                            returnStdout: true
                        ).trim()
                    }

                    echo "ğŸ“ Yeni oluÅŸturulan klasÃ¶r: ${newFolder}"
                    echo "ğŸš€ Ã‡oklu ticket Java kopyalama baÅŸlÄ±yor..."

                    def tickets = params.TICKET_PATHS.split(',').collect { it.trim() }
                    def ticketList = tickets.join(' ')

                    withCredentials([sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                      keyFileVariable: 'SSH_KEY',
                                                      usernameVariable: 'SSH_USER')]) {

                        sh """
                            for ticket in ${ticketList}; do
                                echo "ğŸ”¥ Ticket iÅŸleniyor: \$ticket"

                                for file in \$(find "\$ticket" -type f -name "*.java" \
                                                    ! -path "*/BACKUP/*" \
                                                    ! -path "*/Backup/*"); do

                                    echo "ğŸ” Java: \$file"
                                    pkg_line=\$(grep -m1 '^package' "\$file" | sed 's/package //' | sed 's/;//')

                                    if [ -z "\$pkg_line" ]; then
                                        echo "âš ï¸ package bulunamadÄ± â†’ geÃ§iliyor"
                                        continue
                                    fi

                                    pkg_path=\$(echo "\$pkg_line" | tr '.' '/')
                                    target_dir="${BASE_DIR}/${newFolder}/java/source/cm/\$pkg_path"

                                    echo "ğŸ“‚ Hedef: \$target_dir"
                                    ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no "\$SSH_USER"@${REMOTE_HOST} "mkdir -p \$target_dir"
                                    scp -i "\$SSH_KEY" -o StrictHostKeyChecking=no "\$file" "\$SSH_USER"@${REMOTE_HOST}:\$target_dir/
                                done
                            done
                        """
                    }

                    echo "âœ… Ã‡oklu ticket Java dosyalarÄ± baÅŸarÄ±yla gÃ¶nderildi."
                }
            }
        }

        stage('Manuel Onay') {
            steps {
                input message: "â˜• Java dosyalarÄ± gÃ¶nderildi. Devam etmek iÃ§in Proceed."
            }
        }

        stage('ApplyCM') {
            steps {
                script {
                    echo "ğŸš€ ApplyCM Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."

                    withCredentials([sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                      keyFileVariable: 'SSH_KEY',
                                                      usernameVariable: 'SSH_USER')]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no "\$SSH_USER"@${REMOTE_HOST} bash << 'EOF'
                                sh /appdata/scripts/splenv.sh
                                sh /appdata/ouaf/package/CM_EXTRACT/deploy.sh
EOF
                        """
                    }
                }
            }
        }

        stage('Initial Setup') {
            steps {
                script {
                    echo "ğŸ”§ initialSetup Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."

                    withCredentials([sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                      keyFileVariable: 'SSH_KEY',
                                                      usernameVariable: 'SSH_USER')]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${REMOTE_HOST} "
                                        sh /appdata/scripts/splenv.sh << EOF
                                        sh /appdata/ouaf/CCBMIG/bin/initialSetup.sh << EOF
                                        EOF
                                    "
                        """
                    }
                }
            }
        }

        stage('Batch Sunucusuna scp') {
            steps {
                script {
                    echo "ğŸ“¦ cm.jar batch sunucusuna gÃ¶nderiliyor..."

                    withCredentials([sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                      keyFileVariable: 'SSH_KEY',
                                                      usernameVariable: 'SSH_USER')]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no "\$SSH_USER"@REMOTE_HOST bash << 'EOF'
                                scp /appdata/ouaf/CCBMIG/etc/lib/cm.jar "\$SSH_USER"@BATCH_HOST:/appdata/ouaf/CCBMIG/etc/lib/
EOF
                        """
                    }
                }
            }
        }

        stage('Batch Sunucusu BaÄŸlantÄ±') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                   keyFileVariable: 'SSH_KEY',
                                                   usernameVariable: 'SSH_USER')]) {

                    sh """
                        ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no "\$SSH_USER"@BATCH_HOST bash << 'EOF'
                            echo 'ğŸ“ batch sunucusuna giriÅŸ yapÄ±ldÄ±'
                            cd /appdata/scripts/
                            sh cm_jar.sh
EOF
                    """
                }
            }
        }

        stage('Restart Onay') {
            steps {
                input message: "â˜• ApplyCM + initialSetup tamamlandÄ±. Restart iÃ§in Proceed."
            }
        }

        stage('Weblogic Restart') {
            steps {
                script {
                    echo "ğŸ”„ Weblogic restart baÅŸlatÄ±lÄ±yor..."

                    withCredentials([sshUserPrivateKey(credentialsId: SSH_CRED_ID,
                                                       keyFileVariable: 'SSH_KEY',
                                                       usernameVariable: 'SSH_USER')]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no "\$SSH_USER"@${REMOTE_HOST} bash << 'EOF'
                                cd /appdata/restartconfig
                                sh starter.sh
EOF
                        """
                    }
                }
            }
        }
    }
}
