pipeline {
    agent any

    parameters {
        string(
            name: 'TICKET_PATHS',
            defaultValue: '2025/09/CTM-5228,2025/10/CTM-6001',
            description: 'Birden fazla ticketƒ± virg√ºlle ayƒ±rarak yaz (√∂rn: 2025/09/CTM-5228,2025/10/CTM-6001)'
        )
    }

    environment {
        GIT_REPO_URL = 'git_url'
        SSH_CRED_ID  = 'ccb-deploy-ssh'     // Jenkins SSH key ID

        HOST_1 = ''
        HOST_2 = ''
        HOST_3 = ''

        BASE_DIR = '/appdata/ouaf/package/CM_EXTRACT'
    }

    stages {

        /* ============================================================
         *                    GIT CHECKOUT
         * ============================================================ */
        stage('Checkout') {
            steps {
                script {
                    echo "üì¶ Git deposu indiriliyor..."

                    git branch: 'master',
                        credentialsId: 'gitlab-account-token',
                        url: "${GIT_REPO_URL}"

                    // Ticket listesini b√∂l
                    tickets = params.TICKET_PATHS.split(',').collect { it.trim() }

                    // Her ticket kontrol edilir
                    tickets.each { t ->
                        sh "ls -l ${t} || (echo '‚ùå ${t} klas√∂r√º bulunamadƒ±!' && exit 1)"
                    }

                    echo "üéü Ticket listesi: ${tickets}"
                }
            }
        }

        /* ============================================================
         *   PAKET OLU≈ûTURMA + √áOKLU TICKET JAVA KOPYALAMA
         * ============================================================ */
        stage('Paket Olu≈üturma & Java Kopyalama') {
            steps {
                script {
                    def newFolder = ""

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        /* Yeni klas√∂r olu≈ütur */
                        newFolder = sh(
                            script: """
                                ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_1} \
                                "bash ${BASE_DIR}/isimdegistirmeoto.sh" | head -n 1
                            """,
                            returnStdout: true
                        ).trim()

                        echo "üìÅ Yeni CM klas√∂r√º: ${newFolder}"

                        /* ============================================================
                         *    T√úM Tƒ∞CKET KLAS√ñRLERƒ∞Nƒ∞N JAVA DOSYALARINI Y√úKLE
                         * ============================================================ */
                        tickets.each { ticket ->

                            echo "üî• ƒ∞≈üleniyor: ${ticket}"

                            sh """
                                for file in \$(find ${ticket} -type f -name "*.java" \
                                            ! -path "*/BACKUP/*" ! -path "*/Backup/*"); do

                                    echo "üîç Java dosyasƒ± bulundu: \$file"

                                    pkg_line=\$(grep -m1 '^package' "\$file" | sed 's/package //' | sed 's/;//')
                                    [ -z "\$pkg_line" ] && echo "‚ö†Ô∏è Package bulunamadƒ± ‚Üí atlanƒ±yor" && continue

                                    pkg_path=\$(echo "\$pkg_line" | tr '.' '/')

                                    target_dir="${BASE_DIR}/${newFolder}/java/source/cm/\$pkg_path"

                                    ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_1} "mkdir -p \$target_dir"

                                    scp -i "\$SSH_KEY" -o StrictHostKeyChecking=no "\$file" \
                                        \$SSH_USER@${HOST_1}:\$target_dir/
                                done
                            """
                        }
                    }

                    echo "üéØ T√ºm ticket‚Äôlardaki Java dosyalarƒ± ba≈üarƒ±yla g√∂nderildi."
                }
            }
        }

        /* ============================================================
         *                  MANUEL ONAY
         * ============================================================ */
        stage('Onay 1') {
            steps {
                input message: "‚òï Java y√ºkleme tamamlandƒ±. Devam etmek i√ßin Proceed."
            }
        }

        /* ============================================================
         *                        APPLY CM
         * ============================================================ */
        stage('ApplyCM') {
            steps {
                script {
                    echo "üöÄ ApplyCM ba≈ülatƒ±lƒ±yor..."

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_1} "
                                sh /appdata/scripts/splenv.sh << 'EOF'
                                sh /appdata/ouaf/package/CM_EXTRACT/deploy.sh
                                EOF
                            "
                        """
                    }
                }
            }
        }

        /* ============================================================
         *                     INITIAL SETUP
         * ============================================================ */
        stage('InitialSetup') {
            steps {
                script {
                    echo "üîß initialSetup √ßalƒ±≈ütƒ±rƒ±lƒ±yor..."

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_1} "
                                        sh /appdata/scripts/splenv.sh << EOF
                                        sh /appdata/ouaf/CCBMIG/bin/initialSetup.sh << EOF
                                    "
                        """
                    }
                }
            }
        }

        /* ============================================================
         *                      MANUEL ONAY 2
         * ============================================================ */
        stage('Onay 2') {
            steps {
                input message: "‚òï ApplyCM + initialSetup tamamlandƒ±. Proceed ile cm.jar a≈üamasƒ±na ge√ß."
            }
        }

        /* ============================================================
         *                      CM.JAR ‚Üí XXY & XXZ
         * ============================================================ */
        stage('cm.jar Aktarƒ±m') {
            steps {
                script {
                    echo "üì¶ cm.jar 2 ve 3 sunucularƒ±na aktarƒ±lƒ±yor..."

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no "\$SSH_USER"@${HOST_1} '
                            set -e
                            echo "SOURCE: \$(hostname)"
                            ls -l /appdata/ouaf/CCBMIG/etc/lib/cm.jar
                
                            scp -o StrictHostKeyChecking=no /appdata/ouaf/CCBMIG/etc/lib/cm.jar \
                              ${SSH_USER}@${HOST_2}:/appdata/ouaf/CCBMIG/etc/lib/
                
                            scp -o StrictHostKeyChecking=no /appdata/ouaf/CCBMIG/etc/lib/cm.jar \
                              ${SSH_USER}@${HOST_3}:/appdata/ouaf/CCBMIG/etc/lib/
                        """
                    }
                }
            }
        }

        stage('cm.jar G√ºncelle (2)') {
            steps {
                script {
                    echo "üîß 2 ‚Üí cm_jar.sh √ßalƒ±≈üƒ±yor..."

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_2} "
                                cd /appdata/scripts
                                sh cm_jar.sh
                            "
                        """
                    }
                }
            }
        }

        stage('cm.jar G√ºncelle (3)') {
            steps {
                script {
                    echo "üîß 3 ‚Üí cm_jar.sh √ßalƒ±≈üƒ±yor..."

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_3} "
                                cd /appdata/scripts
                                sh cm_jar.sh
                            "
                        """
                    }
                }
            }
        }

        /* ============================================================
         *                            STOP
         * ============================================================ */
        stage('STOP') {
            steps {
                script {
                    echo "üõë stop.sh ba≈ülatƒ±lƒ±yor..."

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_1} "
                                cd /appdata/restart
                                sh stop.sh
                            "
                        """
                    }
                }
            }
        }

        /* ============================================================
         *                     RENAMEFOLDER (XXX & XXY)
         * ============================================================ */
        stage('renamefolder (1)') {
            steps {
                script {
                    echo "üìÅ renamefolder2.sh √ßalƒ±≈üƒ±yor (1)..."

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_1} "
                                cd /appdata/scripts
                                sh renamefolder2.sh
                            "
                        """
                    }
                }
            }
        }

        stage('renamefolder (2)') {
            steps {
                script {
                    echo "üìÅ renamefolder2.sh √ßalƒ±≈üƒ±yor (2)..."

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_2} "
                                cd /appdata/scripts
                                sh renamefolder2.sh
                            "
                        """
                    }
                }
            }
        }

        /* ============================================================
         *                            START
         * ============================================================ */
        stage('START') {
            steps {
                script {
                    echo "üöÄ start.sh ba≈ülatƒ±lƒ±yor..."

                    withCredentials([sshUserPrivateKey(
                        credentialsId: SSH_CRED_ID,
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )]) {

                        sh """
                            ssh -i "\$SSH_KEY" -o StrictHostKeyChecking=no \$SSH_USER@${HOST_1} "
                                cd /appdata/restart
                                sh start.sh
                            "
                        """
                    }
                }
            }
        }

    }
}
