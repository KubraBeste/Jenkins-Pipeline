pipeline {
    agent any

    parameters {
        string(
            name: 'TICKET_PATH',
            defaultValue: '2025/09/CTM-5228',
            description: 'Yƒ±l/Ay/Ticket formatƒ±nda yaz (√∂rnek: 2025/09/CTM-5228)'
        )
    }

    environment {
        GIT_REPO_URL = ''
        SSH_CRED_ID  = ''
        REMOTE_HOST  = ''
        BASE_DIR     = ''
    }

    stages {

        stage('Checkout from GitLab') {
            steps {
                script {
                    echo "üì¶ Git deposu indiriliyor..."
                    git branch: 'master',
                        credentialsId: 'gitlab-account-token',
                        url: "${GIT_REPO_URL}"

                    echo "üéü Ticket path: ${params.TICKET_PATH}"
                    sh "ls -l ${params.TICKET_PATH} || (echo '‚ùå ${params.TICKET_PATH} bulunamadƒ±!' && exit 1)"
                }
            }
        }

        stage('Validate Ticket Path') {
            steps {
                sh '''
                    set -e
                    echo "üé´ Ticket path kontrol ediliyor: ${TICKET_PATH}"

                    if [ ! -d "${TICKET_PATH}" ]; then
                        echo "‚ùå Ticket path bulunamadƒ±: ${TICKET_PATH}"
                        exit 1
                    fi
                '''
            }
        }

        stage('Copy XSL Files (Ticket Path Based)') {
            steps {
                sshagent(credentials: ["${SSH_CRED_ID}"]) {
                    sh '''
                        set -e
                        echo "üìÑ ${TICKET_PATH} altƒ±ndaki XSL dosyalarƒ± (Backup hari√ß):"

                        find ${TICKET_PATH} \
                          -type d \\( -iname backup -o -iname Backup -o -iname BACKUP \\) -prune \
                          -o -type f -name "*.xsl" -print

                        echo "üöÄ XSL dosyalarƒ± deploy ediliyor..."

                        find ${TICKET_PATH} \
                          -type d \\( -iname backup -o -iname Backup -o -iname BACKUP \\) -prune \
                          -o -type f -name "*.xsl" \
                          -exec scp -o StrictHostKeyChecking=no {} \
                          cissys@${REMOTE_HOST}:${BASE_DIR}/ \\;
                    '''
                }
            }
        }

        stage('Verify on Remote') {
            steps {
                sshagent(credentials: ["${SSH_CRED_ID}"]) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no \
                            cissys@${REMOTE_HOST} \
                            "ls -l ${BASE_DIR}/*.xsl"
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ ${TICKET_PATH} i√ßin XSL deploy ba≈üarƒ±yla tamamlandƒ±."
        }
        failure {
            echo "‚ùå ${TICKET_PATH} i√ßin deploy ba≈üarƒ±sƒ±z."
        }
    }
}
